#!/usr/bin/env python3
"""
Joint Controller Node
ê´€ì ˆ(ìœ„ì¹˜ì œì–´) ëª¨í„° í†µí•© ì œì–´

ì—­í• :
- Manual ëª¨ë“œ: ë¦¬ëª¨ì½˜ ìŠ¤ìœ„ì¹˜ â†’ ìƒëŒ€ ìœ„ì¹˜ ì œì–´ (S17, S18, S21, S22, S23, S24)
- Auto ëª¨ë“œ: ìƒìœ„ ê³„ì¸µ ëª…ë ¹ â†’ ì ˆëŒ€/ìƒëŒ€ ìœ„ì¹˜ ì œì–´

ì œì–´ ëª¨í„°:
- 0x143: íš¡ì´ë™ (Lateral Move)
- 0x144: Xì¶•
- 0x145: Yì¶•
- 0x146: Zì¶•
- 0x147: Yaw íšŒì „
"""

import rclpy
from rclpy.node import Node
from rebar_base_interfaces.msg import RemoteControl, JointControl
from std_msgs.msg import String
import time


class JointController(Node):
    """ê´€ì ˆ ìœ„ì¹˜ ì œì–´ë¥¼ í†µí•© ê´€ë¦¬í•˜ëŠ” ë…¸ë“œ"""

    def __init__(self):
        super().__init__('joint_controller')

        # íŒŒë¼ë¯¸í„° ì„ ì–¸
        self.declare_parameter('lateral_step_deg', 360.0)  # S17, S18 ë‹¨ìœ„ (ë„)
        self.declare_parameter('lateral_max_speed', 150.0)  # 0x143 ìµœëŒ€ ì†ë„ (dps)
        self.declare_parameter('yaw_step_deg', 5.0)  # S23, S24 ë‹¨ìœ„ (ë„)
        self.declare_parameter('yaw_max_speed', 134.0)  # 0x147 ìµœëŒ€ ì†ë„ (dps)
        self.declare_parameter('command_interval', 0.3)  # ëª…ë ¹ ê°„ ìµœì†Œ ê°„ê²© (ì´ˆ)

        # íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
        self.lateral_step = self.get_parameter('lateral_step_deg').value
        self.lateral_speed = self.get_parameter('lateral_max_speed').value
        self.yaw_step = self.get_parameter('yaw_step_deg').value
        self.yaw_speed = self.get_parameter('yaw_max_speed').value
        self.command_interval = self.get_parameter('command_interval').value

        # ìƒíƒœ ë³€ìˆ˜
        self.control_mode = 'idle'  # idle, manual, auto
        self.last_command_time = {}  # ëª¨í„°ë³„ ë§ˆì§€ë§‰ ëª…ë ¹ ì‹œê°„
        self.current_positions = {
            0x143: 0.0,  # íš¡ì´ë™
            0x144: 0.0,  # Xì¶•
            0x145: 0.0,  # Yì¶•
            0x146: 0.0,  # Zì¶•
            0x147: 0.0,  # Yaw
        }

        # ì´ì „ ìŠ¤ìœ„ì¹˜ ìƒíƒœ (ì—£ì§€ ê°ì§€ìš©)
        self.prev_buttons = [0] * 8

        # ROS2 Subscribers
        self.remote_control_sub = self.create_subscription(
            RemoteControl,
            '/remote_control',
            self.remote_control_callback,
            10
        )

        self.control_mode_sub = self.create_subscription(
            String,
            '/authority_status',
            self.control_mode_callback,
            10
        )

        # Auto ëª¨ë“œìš© ìƒìœ„ ê³„ì¸µ ëª…ë ¹ (ì¶”í›„ êµ¬í˜„)
        # self.joint_command_sub = ...

        # ROS2 Publisher
        self.joint_control_pub = self.create_publisher(
            JointControl,
            '/joint_control',
            10
        )

        self.get_logger().info("Joint Controller ë…¸ë“œ ì´ˆê¸°í™” ì™„ë£Œ")
        self.get_logger().info(f"  - Lateral step: {self.lateral_step}Â° @ {self.lateral_speed} dps")
        self.get_logger().info(f"  - Yaw step: {self.yaw_step}Â° @ {self.yaw_speed} dps")
        self.get_logger().info(f"  - Command interval: {self.command_interval}s")

    def control_mode_callback(self, msg):
        """ì œì–´ ëª¨ë“œ ì—…ë°ì´íŠ¸"""
        old_mode = self.control_mode
        self.control_mode = msg.data

        if old_mode != self.control_mode:
            self.get_logger().info(f"ì œì–´ ëª¨ë“œ ë³€ê²½: {old_mode} â†’ {self.control_mode}")

    def remote_control_callback(self, msg):
        """
        ë¦¬ëª¨ì½˜ ì‹ í˜¸ ì²˜ë¦¬ (Manual ëª¨ë“œ ì „ìš©)

        ë²„íŠ¼ ë§¤í•‘ (can_parser.py ì°¸ì¡°):
        - buttons[0]: S13 (ë¸Œë ˆì´í¬)
        - buttons[1]: S14 (ë¦¬ì…‹)
        - buttons[2]: S17
        - buttons[3]: S18
        - buttons[4]: S21
        - buttons[5]: S22
        - buttons[6]: S23
        - buttons[7]: S24
        """
        # Manual ëª¨ë“œì—ì„œë§Œ ë™ì‘
        if self.control_mode != 'manual':
            return

        # S17, S18: íš¡ì´ë™ (0x143) Â±360ë„
        self._handle_lateral_move(msg)

        # S23, S24: Yaw íšŒì „ (0x147) Â±5ë„
        self._handle_yaw_rotation(msg)

        # S21, S22: ì‘ì—… ì‹œí€€ìŠ¤ (ì¶”í›„ êµ¬í˜„)
        # self._handle_work_sequence(msg)

        # ì´ì „ ë²„íŠ¼ ìƒíƒœ ì €ì¥
        self.prev_buttons = msg.buttons.copy() if msg.buttons else [0] * 8

    def _handle_lateral_move(self, msg):
        """
        íš¡ì´ë™ ì œì–´ (S17/S18: Â±360ë„)
        0x143 ëª¨í„°
        """
        if not msg.buttons or len(msg.buttons) < 4:
            return

        s17 = msg.buttons[2]
        s18 = msg.buttons[3]
        prev_s17 = self.prev_buttons[2] if len(self.prev_buttons) > 2 else 0
        prev_s18 = self.prev_buttons[3] if len(self.prev_buttons) > 3 else 0

        # ì—£ì§€ ê°ì§€ (0 â†’ 1)
        s17_pressed = (prev_s17 == 0 and s17 == 1)
        s18_pressed = (prev_s18 == 0 and s18 == 1)

        if s17_pressed:
            # +360ë„ íšŒì „
            self._send_relative_position(
                motor_id=0x143,
                delta_position=self.lateral_step,
                max_speed=self.lateral_speed,
                name='íš¡ì´ë™'
            )

        elif s18_pressed:
            # -360ë„ íšŒì „
            self._send_relative_position(
                motor_id=0x143,
                delta_position=-self.lateral_step,
                max_speed=self.lateral_speed,
                name='íš¡ì´ë™'
            )

    def _handle_yaw_rotation(self, msg):
        """
        Yaw íšŒì „ ì œì–´ (S23/S24: Â±5ë„)
        0x147 ëª¨í„°
        """
        if not msg.buttons or len(msg.buttons) < 8:
            return

        s23 = msg.buttons[6]
        s24 = msg.buttons[7]
        prev_s23 = self.prev_buttons[6] if len(self.prev_buttons) > 6 else 0
        prev_s24 = self.prev_buttons[7] if len(self.prev_buttons) > 7 else 0

        # ì—£ì§€ ê°ì§€ (0 â†’ 1)
        s23_pressed = (prev_s23 == 0 and s23 == 1)
        s24_pressed = (prev_s24 == 0 and s24 == 1)

        if s23_pressed:
            # +5ë„ íšŒì „
            self._send_relative_position(
                motor_id=0x147,
                delta_position=self.yaw_step,
                max_speed=self.yaw_speed,
                name='Yaw'
            )

        elif s24_pressed:
            # -5ë„ íšŒì „
            self._send_relative_position(
                motor_id=0x147,
                delta_position=-self.yaw_step,
                max_speed=self.yaw_speed,
                name='Yaw'
            )

    def _send_relative_position(self, motor_id, delta_position, max_speed, name='Joint'):
        """
        ìƒëŒ€ ìœ„ì¹˜ ì œì–´ ëª…ë ¹ ì „ì†¡

        Parameters:
        - motor_id: ëª¨í„° CAN ID (0x143, 0x147 ë“±)
        - delta_position: ìƒëŒ€ ì´ë™ëŸ‰ (degree)
        - max_speed: ìµœëŒ€ ì†ë„ (dps)
        - name: ëª¨í„° ì´ë¦„ (ë¡œê¹…ìš©)
        """
        # ëª…ë ¹ ê°„ê²© ì²´í¬ (ê³¼ë¶€í•˜ ë°©ì§€)
        current_time = time.time()
        if motor_id in self.last_command_time:
            elapsed = current_time - self.last_command_time[motor_id]
            if elapsed < self.command_interval:
                self.get_logger().warn(
                    f"â¸ï¸  {name} (0x{motor_id:03X}) ëª…ë ¹ ê°„ê²© ë¶€ì¡±: {elapsed:.2f}s < {self.command_interval}s"
                )
                return

        # í˜„ì¬ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (ëˆ„ì )
        self.current_positions[motor_id] += delta_position

        # JointControl ë©”ì‹œì§€ ìƒì„±
        msg = JointControl()
        msg.joint_id = motor_id
        msg.position = delta_position  # ìƒëŒ€ ìœ„ì¹˜
        msg.velocity = max_speed
        msg.control_mode = JointControl.MODE_RELATIVE  # ìƒëŒ€ ìœ„ì¹˜ ëª¨ë“œ

        # ë°œí–‰
        self.joint_control_pub.publish(msg)

        # ë¡œê·¸
        direction = "+" if delta_position > 0 else ""
        self.get_logger().info(
            f"ğŸ”§ {name} (0x{motor_id:03X}): {direction}{delta_position:.1f}Â° "
            f"@ {max_speed:.0f} dps (ëˆ„ì : {self.current_positions[motor_id]:.1f}Â°)"
        )

        # ë§ˆì§€ë§‰ ëª…ë ¹ ì‹œê°„ ê¸°ë¡
        self.last_command_time[motor_id] = current_time

    def _send_absolute_position(self, motor_id, target_position, max_speed, name='Joint'):
        """
        ì ˆëŒ€ ìœ„ì¹˜ ì œì–´ ëª…ë ¹ ì „ì†¡ (Auto ëª¨ë“œìš©, ì¶”í›„ êµ¬í˜„)

        Parameters:
        - motor_id: ëª¨í„° CAN ID
        - target_position: ëª©í‘œ ì ˆëŒ€ ìœ„ì¹˜ (degree)
        - max_speed: ìµœëŒ€ ì†ë„ (dps)
        - name: ëª¨í„° ì´ë¦„ (ë¡œê¹…ìš©)
        """
        # JointControl ë©”ì‹œì§€ ìƒì„±
        msg = JointControl()
        msg.joint_id = motor_id
        msg.position = target_position
        msg.velocity = max_speed
        msg.control_mode = JointControl.MODE_ABSOLUTE

        # ë°œí–‰
        self.joint_control_pub.publish(msg)

        # ë¡œê·¸
        self.get_logger().info(
            f"ğŸ¯ {name} (0x{motor_id:03X}): â†’ {target_position:.1f}Â° "
            f"@ {max_speed:.0f} dps (ì ˆëŒ€ìœ„ì¹˜)"
        )


def main(args=None):
    rclpy.init(args=args)
    node = JointController()

    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass
    finally:
        node.destroy_node()
        rclpy.shutdown()


if __name__ == '__main__':
    main()
